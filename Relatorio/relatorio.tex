%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% PREAMBLE %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 1. Load 'Universal' Toolkit (Project-Agnostic)
\input{preambulo.tex}

\addbibresource{Otimizacao-bib-relatorio.bib}
\graphicspath{ {./imagens/} }


\titulo{Aplicação do problema da p-mediana na distrubuição de hospitais na cidade de São Carlos - SP}
\autor{Fabio Kauê Araujo da Silva - 16311045\\
                    Gabriel Inumaru Esteves- 15453487\\
                    Kainã Alves Tureso - 15466391\\
                    MatheusSpinellide Paiva - 14598682\\
                    Pedro Luís Anghievisck - 15656521}
\date{\today}
\local{São Carlos - SP}
\instituicao{USP - Universidade de São Paulo\\
            ICMC - Instituto de Ciências Matemáticas e de Computação}


\begin{document}
% --- TITLE BLOCK ---
    \imprimircapa
    \tableofcontents

    \textual
    \pagestyle{plain}

    \setcounter{page}{1}
    % --- CONTENT ---
    \chapter{Introdução}
    \thispagestyle{plain}

    Afim de proporcionar um melhor atendimento à população de uma determinada cidade, a um determinado serviço, é crucial que o acesso geográfico seja, em alguma métrica, igualitário entre os indivíduos. Uma dessas formas de se medir esse acesso é através da distância entre os indivíduos e os pontos de atendimento. Assim, o problema da p-mediana $(pMP)$ busca, dado um conjunto de pontos (indivíduos) e um número p, selecionar p pontos (locais de atendimento) de forma a minimizar a soma das distâncias entre cada ponto e o ponto mais próximo selecionado.

    Uma das aplicações do $pMP$ é na localização de hospitais em uma cidade, onde o objetivo é minimizar a distância total que os habitantes da cidade precisam percorrer para chegar ao hospital mais próximo. Neste relatório, exploramos a aplicação do problema da p-mediana na distribuição de hospitais na cidade de São Carlos - SP. Utilizando dados geográficos reais, modelamos o problema como um problema de otimização linear e implementamos uma solução computacional utilizando o método Simplex primal.






    \chapter{Objetivos}
    \thispagestyle{plain}
    O objetivo desse trabalho é comparar a disposição real de hospitais na cidade de São Carlos-SP com resultados obtidos através da aplicação do $pMP$ como um problema de otimização linear, além de sugirir possíveis novas localizações ótimas (no sentido de minimizar distâncias) para a construção desses estabelecimentos na cidade.





    \chapter{Revisão Bibliográfica}
    \thispagestyle{plain}
        \section{Grafos}
        As seguintes definições são dadas em \cite{AURICHI}:

        \begin{definition} \label{def:grafo}
            Um \textbf{grafo} é o par $G=(V,E)$ em que $V$ é um conjunto de pontos denotado \textbf{vértices} e $E\subset V^2$ é o conjunto de \textbf{arestas}.
        \end{definition}

        Informalmente, pode-se definir um grafo como um conjunto de pontos ligados de alguma forma. Um exemplo, que será usado nesse estudo, é a malha viária de uma cidade, na qual as ruas representam as arestas e os pontos são as esquinas. Nesse caso, cada rua tem um tamanho, o que torna o grafo \textbf{ponderado}.
        
        \begin{definition} \label{def:caminho}
            Dizemos que um grafo $G=(V,E)$ não vazio é um \textbf{caminho} se é da forma $V = \{x_1, x_2, \dots, x_n\}$ e $E = \{(x_1,x_2), (x_2,x_3), \dots, (x_{n-1}, x_n)\}$
        \end{definition}
        
        As duas definições seguintes serão usadas posteriormente na \autoref{subsec:pMP-linear} para resultados sobre a possibilidade de transformar o $pMP$ em um problema linear.
        
        \begin{definition} \label{def:conexo}
            Dizemos que um grafo $G=(V,E)$ é \textbf{conexo} se dados dois vértices $u,v \in V$, existe um caminho $A = (P, C)$ tal que $u,v \in P$. 
        \end{definition}
        
        \begin{definition} \label{def:ciclo}
            Dizemos que um grafo é um \textbf{ciclo} se é um caminho e suas extremidades são iguais.
        \end{definition}

        
            \subsection{Algoritmos de distância mínima}

            Na \autoref{sec:implementação}, será necessário avaliar a distância mínima entre cada nó de um grafo ponderado com valores não negativos. Dentre as formas de computar essas distâncias, dois algoritmos principais são considerados: o algoritmo de Dijkstra e o algoritmo de Floyd-Warshall.

            O algoritmo de Dijkstra calcula, dado um vértice, a distância mínima entre todos os outros vértices de um grafo com complexidade (a depender da implementação) de $O((|V|+|E|)\log|V|)$, de acordo com \cite[p.~106]{roughgarden2018algorithms2}. Note que, para grafos esparsos, ou seja, $|E| = O(|V|)$, podemos aproximar a complexidade para $O(|E|\log|V|)$. Nesse caso, para calcular a distância entre todos os vértices de um grafo, temos que aplicar o algoritmo de Dijkstra $|V|$ vezes, o que resulta em uma complexidade de $O(|V||E|\log|V|) \approx O(|V|^2\log|V|)$.

            O algoritmo de Floyd-Warshall calcula a distância mínima entre todos os pares de vértices de um grafo, com complexidade $O(|V|^3)$, de acordo com \cite{clrs4}. 


        \section{Problema da p-mediana} \label{sec:p-mediana}
            O problema da p-mediana ($pMP$) é um problema de otimização inteira em que o objetivo é encontrar a localização de $p$ instalações em uma rede/grafo, tal que o custo total seja reduzido \cite{DASKIN2013}. O custo em um nó $i \in I$ é dado pelo produto da demanda em $i$ e a distância entre o nó $i$ e a instação mais perta de $i$. Assim, podemos formular o problema formalmente:
            
            Seja $I$ um conjunto de nós num grafo e $J \subseteq I$ o conjunto dos nós candidatos a receberem uma instalação.

            \textbf{Entradas}

            \begin{itemize}
                \item $h_i$ = demanda no nó $i \in I$
                \item $d_{ij}$ = distância entre o nó de demanda $i \in I$ e o lugar canditato $j \in J$
                \item $p$ = número de instalações a serem construídas
            \end{itemize}

            \textbf{Variáveis de decisão}

            \begin{itemize}
                \item $X_j = \begin{cases}
                    1, \text{ se colocarmos uma instalação no local} j \in J \\
                    0, \text{ caso contrário}
                \end{cases}$
                \item $Y_{ij} = \begin{cases}
                    1, \text{ se o nó} i \in I \text{ é servido pela instalação no nó } j \in J \\
                    0, \text{ caso contrário}
                \end{cases}$
            \end{itemize}

            Formulamos então o problema: 
            \begin{problem} \label{problem:pMP-inteiro}
                \begin{align} 
                    \text{Minimizar }     & \sum_{i\in I} \sum_{j \in J} h_i d_{ij} Y_{ij}    & \\
                    \text{Sujeito a }   & \sum_{j\in J} Y_{ij} = 1                          & \forall i \in I \\
                                        & \sum_{j \in J} X_j = p                            & \\
                                        & Y_{ij} - X_{j} \leq 0                             & \forall i \in I; j \in J \\
                                        & X_j \in \{0,1\}                                   & \forall j \in J \\
                                        & Y_{ij} \in \{0,1\}                                & \forall i \in I; j \in J 
                \end{align}
            \end{problem}
             A função objetivo $(3.1)$ minimiza as distâncias ponderada pela demanda de cada nó em relação à instalação mais próxima. A restrição $(3.2)$ diz que cada nó só pode estar designado a uma instalação e a $(3.3)$ restringe o número de instalação a ser exatamente $p$. A restrição $(3.4)$ expressa a necessidade de interligar as variáveis de localização $(X_j)$ com as variáveis de alocação $(Y_{ij})$. Ela diz que se um nó $i$ foi designado a um local $j$, então, necessariamente, $j$ tem que ter uma instalação, ou seja, $X_j = 1$. As restrições $(3.5)$ e $(3.6)$ são as condições de integralidade.
            

            \subsection{p-mediana como problema de otimização linear} \label{subsec:pMP-linear}
                Note que o problema \autoref{problem:pMP-inteiro} é NP-difícil \cite[p.~241]{DASKIN2013}, ou seja, computá-lo é extremamente difícil. Uma das formas para tentar reduzir o tempo necessário para resolver o problema, é considerar o proceso de relaxação linear, em que as restrições de integralidade são completamente retiradas ou substuídas por restrições que limitam as variáveis a um intervalo. Com esse processo, criamos um problema linear similar, que é computável em tempo polinomial.

                Em particular, se os conjuntos iniciais das restrições de integralidade estão contidos nos novos intervalos de restrição, então existem mais valores possíveis no problema linear do que no problema inteiro. Logo, o problema linear nos dá uma cota para o valor ótimo do problema inteiro. Além disso, se a tradução linear tem um resultado que satisfaz as condições de integralidade antigas, então essa solução também resolve o problema inteiro.

                Para o $pMP$, podemos substítuir as restrições de integralidade $(3.5)$ e $(3.6)$ por:
                \begin{align}
                    0 \leq X_j \leq 1 && \forall j \in J \\
                    0 \leq Y_{ij} \leq 1 && \forall i \in I; j \in J 
                \end{align}

                Para resultados não inteiros, pode-se interpretar a associação das variáveis de decisão como uma medida do quão bom é fazer uma instalação em determinado local. Com isso, temos o problema linear:
                \begin{problem} \label{problem:pMP-linear}
                    \begin{align} 
                        \text{Minimizar }     & \sum_{i\in I} \sum_{j \in J} h_i d_{ij} Y_{ij}    & \notag \\
                        \text{Sujeito a }   & \sum_{j\in J} Y_{ij} = 1                          & \forall i \in I \notag \\
                                            & \sum_{j \in J} X_j = p                            & \notag \\
                                            & Y_{ij} - X_{j} \leq 0                             & \forall i \in I; j \in J \notag \\
                                            & 0 \leq X_j \leq 1                                 & \forall j \in J \notag \\
                                            & 0 \leq Y_{ij} \leq 1                              & \forall i \in I; j \in J \notag 
                    \end{align}
                \end{problem}

                Como os únicos inteiros do intervalo que restringe os $Y_{ij}$ e $X_j$ são o $0$ e o $1$, a solução do problema linear equivale à do problema inteiro quando ela é inteira. Uma condição para integralidade no $pMP$ é dado em \cite{BAIOU2011344}, no seguinte teorema:
                \begin{theorem}
                    Seja $G$ um grafo não direcionado conexo. Então o poliedro do problema linear é integral para todo $p \in \mathbb{N}$ (os vértices do poliedro possuem todas entradas inteiras) se e somente se $G$ é um caminho ou um ciclo simples.
                \end{theorem}

                Em geral, as redes nas quais o $pMP$ é proposto são mais complexas do que caminhos ou ciclos. Logo, só é possível saber para quais $p$ o relaxamento dará a solução ótima após computá-la.

        
        \section{Difusão de dados geográficos}
        Em geral, dados populacionais coletados em pesquisas são compilados em parcelas do território. Nas pesquisas do IBGE por exemplo, os setores censitários são a menor unidade territorial de coleta e divulgação de dados. Logo, esses setores representam uma parte da população que mora naquela região, mas não indicam a localização exata de cada indivíduo.
        
        Para o $pMP$, é interessante que os dados sejam mais diluidos, ou seja, que cada indivíduo tenha uma localização específica. Assim, é possível calcular distâncias mais precisas entre os indivíduos e os pontos de instalação. Uma forma de fazer isso é através da difusão dos dados geográficos, que consiste em distribuir os indivíduos de um setor censitário para pontos nele ou próximos a ele. Uma das formas de se fazer isso, que será usada posteriormente, é utilizar uma discretização da equação do calor, dada por:
        \begin{equation}
            \frac{\partial u}{\partial t} = -\eta \nabla^2 u
        \end{equation}
        Em que $u(x,t)$ é a densidade de indivíduos no ponto $x$ no tempo $t$ e $\alpha$ é uma constante de difusão. A equação do calor modela o processo de difusão de calor em um meio, mas pode ser adaptada para modelar a difusão de indivíduos em um espaço geográfico. Com essa equação, utilizamos o método das diferenças finitas para chegar em:
        \begin{equation}
            \frac{u_{n+1}-u_n}{\Delta t} = -\eta \nabla^2 u_n
        \end{equation}
        Logo, temos que:
        \begin{equation}
            u_{n+1} = u_n - \eta \Delta t \nabla^2 u_n
        \end{equation}
        Para grafos, o operador laplaciano $\nabla^2$ é substituído pelo laplaciano discreto, que é dado por $L = D - A$, em que $D$ é a matriz diagonal dos graus dos vértices e $A$ é a matriz de adjacência do grafo. Além disso, $u_k$, nesse caso, representa um vetor com a quantidade de entra igual ao número de nós. Assim, a equação discreta da difusão em grafos é dada por:
        \begin{equation}
            u_{n+1} = u_n - \eta \Delta t L u_n
        \end{equation}
        Tomando $\alpha = \eta \Delta t$, considerando $u_n^k$ a k-ésima entrada do vetor $u_n$ e $L_k$ a k-ésima linha da matriz laplaciana, temos:
        \begin{equation}
            u_{n+1}^k = u_n^k - \alpha L_k^\top u_n
        \end{equation}
        Com algumas manipulações simples, chegamos em:
        \begin{equation}
            u_{n+1}^k = (1-\alpha |N(k)|)u_n^k + A_k^\top u_n
        \end{equation}
        Em que $N(k)$ é o conjunto de vizinhos do nó $k$. Note que, nessa forma, a quantidade de indivíduos em um nó é atualizada com base na quantidade de vizinhos de um determinado nó. Dessa forma, é mais conveniente utilizar a Laplaciana de \textit{random-walk}, dada por $L_{rw} = I - D^{-1}A$ \cite{lu_nankai2014}. Com essa matriz, a equação de difusão fica:
        \begin{equation}
            u_{n+1}^k = (1-\alpha)u_n^k + \alpha  (D^{-1}A)_k^\top u_n
        \end{equation}
        Com isso, a dissipação em cada nó é sempre uma porcentagem constante da quantidade de indivíduos nele, o que é mais intuitivo e prático.

    \chapter{Procedimentos e métodos}
    \thispagestyle{plain}
        \section{Modelagem Matemática}
        Modelamos o problema da localização de hospitais na cidade de São Carlos-SP como um $pMP$ relaxado linearmente, conforme pode ser visto em \autoref{problem:pMP-linear}. Para isso, foi considerado o grafo da malha viária da cidade, onde os nós representam as interseções entre as ruas e as arestas representam os trechos de rua entre essas interseções. Para cada nó foi atribuído um valor de população aproximado, que representa a demanda por serviços hospitalares naquele ponto. As distâncias entre os nós foram calculadas com base no comprimento dos trechos de rua que os conectam. Para os locais candidatos a instalação foram considerados apenas os nós que possuem uma demanda maior que $p_0$, com o inuito de reduzir o custo computacional do problema. Na notação do $pMP$ anteriormente definida, temos que:
        \begin{itemize}
            \item $I$ = conjunto de todos os nós do grafo (interseções da malha viária)
            \item $h_i$ = população aproximada no nó $i \in I$
            \item $J$ = $\{i \in I : h_i \ge p_0\}$
            \item $d_{ij}$ = distância entre o nó de demanda $i \in I$ e o lugar canditato $j \in J$.
            \item $p$ = número de hospitais a serem localizados
        \end{itemize}

        \section{Coleta e Tratamento de Dados}
        O grafo da cidade de São Carlos-SP foi obtido através do OpenStreetMap (OSM) utilizando a biblioteca OSMnx \cite{boeing2017osmnx}. A população aproximada em cada nó foi estimada com base nos dados do censo demográfico do IBGE de 2022 \cite{ibge_malhas_setores2022}, utilizando o método de difusão de dados geográficos descrito na \autoref{sec:p-mediana}.

        Em suma, a população de cada setor foi comprimida para um único nó representativo do setor, e então a difusão foi aplicada para distribuir essa população pelos nós vizinhos na malha viária. Esse processo foi repetido por um número determinado de iterações, resultando em uma distribuição mais realista da população ao longo da malha viária da cidade.

        \section{Implementação Computacional} \label{sec:implementação}


    \chapter{Resultados}
    \thispagestyle{plain}

    \chapter{Conclusão}
    \thispagestyle{plain}


    % --- BIBLIOGRAPHY ---
    \printbibliography
\end{document}